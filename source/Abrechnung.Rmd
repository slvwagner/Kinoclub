---
title: "Abrechnung Filmvorführung"
output: 
  html_document:
    css: Kinoklub_dark.css
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
act_date <- Sys.time()|>as.Date()
act_date <- paste0(day(act_date),".", month(act_date),".", year(act_date))
```

Bericht wurde am `r act_date` erstellt.

```{r variablen, include=FALSE}
ii <- 1
```

```{r echo=FALSE}
df_mapping <- tibble(Datum = c_Date)|>
  mutate(user_Datum = paste0(day(Datum),".", month(Datum),".", year(Datum)),
         index = row_number())

c_Datum <- c_Date[ii]

c_suisa <- df_show|>
  filter(Datum == c_Date[ii])|>
  select(`Suisa Nummer`)|>
  pull()

c_verleiherabgaben <- df_verleiherabgaben|>
  filter(Datum == c_Datum & Suisa == c_suisa)|>
  select(`Abzug [%]`)|>
  pull()
```

## Erfolg
Der Erfolg berechnet sich aus dem Gewinn der Eintritte und des Kiosks. 

```{r echo=FALSE}
df_GV_Vorfuehrung|>
  filter(Datum == c_Datum & `Suisa Nummer` == c_suisa)|>
  left_join(df_show, by = join_by(Datum, `Suisa Nummer`))|>
  mutate(Datum = paste0(lubridate::day(Datum),".", lubridate::month(Datum),".", lubridate::year(Datum)))|>
  select(Datum, Anfang,`Suisa Nummer`, Filmtitel, `Gewinn/Verlust [CHF]`)|>
  mutate(Anfang = paste0(lubridate::hour(Anfang),":", lubridate::minute(Anfang)|>as.character()|>formatC(format = "0", width = 2)|>str_replace(SPC,"0"))
         )|>
  rename(`Total Gewinn [CHF]`=`Gewinn/Verlust [CHF]`)|>
  knitr::kable()


```


### Kino Eintritte

```{r echo=FALSE}
df_Eintritt|>
  filter(Datum == c_Datum & `Suisa Nummer` == c_suisa)|>
  select(Platzkategorie, Verkaufspreis, Anzahl, Umsatz)|>
  rename(`Film Umsatz [sFR]` = `Umsatz`)|>
  knitr::kable()

```


### Kino Eintritte Zusammenfassung

```{r echo=FALSE}
df_Eintritt|>
  filter(Datum == c_Datum & `Suisa Nummer` == c_suisa)|>
  select(Platzkategorie, Verkaufspreis, Anzahl, Umsatz, Zahlend)|>
  group_by(Zahlend)|>
  reframe(Anzahl = sum(Anzahl),
          Umsatz = sum(Umsatz))|>
  mutate(Zahlend = if_else(Zahlend, "Zahlend", "Gratis"))|>
  rename(`Film Umsatz [CHF]` = `Umsatz`,
         Eintritt = Zahlend)|>
  knitr::kable()

```

```{r echo=FALSE}
df_Eintritt|>
  filter(Datum == c_Datum & `Suisa Nummer` == c_suisa)|>
  select(Platzkategorie, Verkaufspreis, Anzahl, Umsatz)|>
  reframe(Eintritt = "Total",
          Anzahl = sum(Anzahl),
          Umsatz = sum(Umsatz))|>
  rename(`Film Umsatz [CHF]` = `Umsatz`)|>
  knitr::kable()

```

### Filmabgaben
Für diesen Film muss an den Verleiher **`r c_verleiherabgaben`%** des Ticket-Umsatz gezahlt werden. Die minimale Abgaben an den Verleiher ist **CHF 150.-**
Der Abgabeprozentsatz ist für jeden Film und Spielwoche mit dem jeweiligen Verleiher verhandelt.
```{r echo=FALSE}
df_temp <- df_GV_Eintritt|>
  filter(Datum == c_Datum & `Suisa Nummer` == c_suisa)|>
  mutate(`Total Abgaben [CHF]` = `SUISA-Abzug [CHF]`+`Verleiher-Abzug [CHF]`)|>
    select(-Datum,-Anfang,-`Suisa Nummer`,-Filmtitel)|>
  rename(`Umsatz [CHF]` = Umsatz)

df_temp|>
  select(-`Gewinn/Verlust [CHF]`)|>
  knitr::kable()
```


```{r echo=FALSE}
df_temp|>
  select(`Gewinn/Verlust [CHF]`)|>
  rename(`Film Gewinn` = `Gewinn/Verlust [CHF]`)|>
  knitr::kable()

```



## Kiosk

```{r echo=FALSE}
df_Kiosk|>
  filter(Datum == c_Datum)|>
  select(-Betrag)|>
  rename(`Kassiert [CHF]` = `Kassiert`,
         `Einkaufspreis [CHF]` =`Einkaufspreis`,
         `Kiosk Gewinn [CHF]` = `Gewinn`,
         `Verkaufspreis [CHF]`=`Verkaufspreis`)|>
  mutate(Datum = paste0(lubridate::day(Datum),".", lubridate::month(Datum),".", lubridate::year(Datum)))|>
  knitr::kable()

```


```{r echo=FALSE}
df_Kiosk|>
  filter(Datum == c_Datum)|>
  select(-Betrag)|>
  reframe(`Kiosk Gewinn [CHF]` = sum(Gewinn))|>
  knitr::kable()
```


#### Kioskumsatz pro Gast

```{r echo=FALSE}
df_show |>
    filter(Datum == c_Datum)|>
  left_join(
    df_Eintritt |>
      group_by(Datum) |>
      reframe(`Besucher` = sum(Anzahl))|>
      left_join(df_Kiosk |>
                  group_by(Datum) |>
                  reframe(Umsatz = sum(Kassiert)),
                by = join_by(Datum)
                ) |>
      mutate(`Umsatz pro Gast [CHF]` = (Umsatz / `Besucher`) |> round(2)),
  by = join_by(Datum)
  )|>
  mutate(Datum = paste0(lubridate::day(Datum),".", lubridate::month(Datum),".", lubridate::year(Datum)))|>
  filter(!is.na(`Suisa Nummer`))|>
    select(-Ende, -Saal, -Version, -Alter, -Datum, -Anfang, -Filmtitel, -`Suisa Nummer`)|>
  rename(`Umsatz [CHF]`= Umsatz)|>
  knitr::kable()

```


#### Kioskumsatz pro zahlender Gast
```{r echo=FALSE}
df_show |>
  filter(Datum == c_Datum)|>
  left_join(
    df_Eintritt |>
      filter(Zahlend)|>
      group_by(Datum) |>
      reframe(`Besucher` = sum(Anzahl))|>
      left_join(df_Kiosk |>
                  group_by(Datum) |>
                  reframe(Umsatz = sum(Kassiert)),
                by = join_by(Datum)
                ) |>
      mutate(`Umsatz pro Gast [CHF]` = (Umsatz / `Besucher`) |> round(2)),
  by = join_by(Datum)
  )|>
  filter(!is.na(`Suisa Nummer`))|>
  select(-Ende, -Saal, -Version, -Alter, -Datum, -Anfang, -Filmtitel, -`Suisa Nummer`)|>
  rename(`Umsatz [CHF]`= Umsatz)|>
  knitr::kable()
```






