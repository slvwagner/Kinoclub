---
title: "Abrechnung Filmvorführung"
output: 
  html_document:
    css: Kinoklub_dark.css
---

```{r setup, include=FALSE}
library(tidyverse)
library(lubridate)
knitr::opts_chunk$set(echo = FALSE)
act_date <- Sys.time()|>as.Date()
act_date <- paste0(day(act_date),".", month(act_date),".", year(act_date))
```

Bericht wurde am `r act_date` erstellt.

```{r variablen, include=FALSE}
ii <- 9
```

```{r echo=FALSE}
df_mapping <- tibble(Datum = c_Date)|>
  mutate(user_Datum = paste0(day(Datum),".", month(Datum),".", year(Datum)),
         index = row_number())

c_Datum <- c_Date[ii]

c_verteilprodukt <- df_Abrechnung|>
  filter(Datum == c_Date[ii])|>
  select(Verteilprodukt)|>
  pull()

 c_linkDatum <- df_Abrechnung|>
  filter(Datum == c_Date[ii])|>
   select(`Link Datum`)|>
   pull()

c_suisa <- df_show|>
  filter(Datum == c_Date[ii])|>
  select(`Suisa Nummer`)|>
  pull()

c_verleiherabgaben <- df_verleiherabgaben|>
  filter(Datum == c_Datum & Suisa == c_suisa)|>
  select(`Abzug [%]`)|>
  pull()
```

## Übersicht

```{r echo=FALSE}
df_temp <- df_show|>
  filter(Datum == c_Datum & `Suisa Nummer` == c_suisa)|>
  mutate(Anfang = paste0(lubridate::hour(Anfang),":", lubridate::minute(Anfang)|>as.character()|>formatC(format = "0", width = 2)|>str_replace(SPC,"0")),
         Datum = paste0(day(Datum),".",month(Datum),".",year(Datum))
         )|>
  select(-Saal)
```

```{r echo=FALSE}
df_temp|>
  knitr::kable(digits = 2)

```

```{r echo=FALSE}
df_temp <- df_keine_Rechnnung|>
  filter(Datum == c_Date[ii])

if(nrow(df_temp) > 0) {
  writeLines("Achtung es gibt noch keine Verleiherabrechnung für diesen Film. Deshalb fehlen die Reklame- und Portokosten.\nDer Gewinn kann sich deshalb noch ändern.")
}

```

\
\
\

## Filmvorführung

### Kino Umsatz

```{r echo=FALSE}
df_temp <- df_Eintritt|>
  filter(Datum == c_Datum & `Suisa Nummer` == c_suisa)|>
  select(Platzkategorie, Verkaufspreis, Anzahl, Umsatz)|>
  rename(`Umsatz [sFR]` = `Umsatz`)

df_temp|>
  knitr::kable()
```

```{r echo=FALSE}
Umsatz <- df_temp|>
  reframe(`Summe Umsatz [CHF]` = sum(`Umsatz [sFR]`, na.rm = T))

Umsatz|>
  knitr::kable()

```

### Kino Besucherzahlen

```{r echo=FALSE}
df_temp <- df_Eintritt|>
  filter(Datum == c_Datum & `Suisa Nummer` == c_suisa)|>
  group_by(Zahlend)|>
  reframe(Anzahl = sum(Anzahl, na.rm = T))|>
  mutate(Zahlend = if_else(Zahlend, "Zahlend", "Gratis"))

```

```{r echo=FALSE}
df_temp|>
  knitr::kable()
```

```{r echo=FALSE}
df_temp|>
  reframe(Summe = sum(Anzahl, na.rm = T))|>
  knitr::kable()

```

### Filmabgaben

Für jeden gezeigten Film sind verschiedenen Abgaben und Gebühren zu entrichten. Es müssen verschieden Scenarien unterschieden werden.

#### Berechnung der Abgaben 
Normalfall: \
Je nach Besucherzahlen ändern sich die Abgaben

- Verleiherrechnung noch nicht vorhanden
    -   Umsatz: \
    Der Umsatz muss je nach Verleiher anders berechnet werden. Bei gewissen Verleihern müssen die Kinoförderer als Umsatz ausgewiesen werden obwohl kein Umsatz an der Kinokasse gemacht wurde.(Die Kinoförderer Tickets werden gegen einen Mitgliederbeitrag abgegeben und wurden demnach Verkauft.)
    -   Suisa-Vorabzug: \
    $U_{msatz}\cdot  \frac {s_{uisaVorabzugProzent}}{100}$
    -   Netto3: \
    $U_{msatz}-S_{uisa-Vorabzug}$
    -   Verleiherabgaben: \
    $N_{etto3} \cdot V_{erleiherabgabenProzent} > M_{indestGarantie} => N_{etto3} \cdot V_{erleiherabgabenProzent}$ \
    $N_{etto3} \cdot V_{erleiherabgabenProzent} < M_{indestGarantie} => M_{indestGarantie}$
    -   Mehrwertsteuer: \
    $V_{erleiherabgaben}\cdot \frac{M_{WST}}{100}$
    -   Gewinn / Verlust: \
    $U_{msatzKinokasse} - S_{uisa-Vorabzug} - V_{erleiherabgaben} - M_{WST}$ 
    
- Verleiherrechnung vorhanden
    -   Umsatz: \
    Der Umsatz muss je nach Verleiher anders berechnet werden. Bei gewissen Verleihern müssen die Kinoförderer als Umsatz ausgewiesen werden obwohl kein Umsatz an der Kinokasse gemacht wurde.(Die Kinoförderer Tickets werden gegen einen Mitgliederbeitrag abgegeben und wurden demnach Verkauft.)
    -   Suisa-Vorabzug: \
    $U_{msatz}\cdot  \frac {s_{uisaVorabzugProzent}}{100}$
    -   Netto3: \
    $U_{msatz}-s_{uisa-Vorabzug}$
    -   Verleiherrechnung: Verleiherrechnungsbetrag inklusive Mehrwertsteuer
    -   Mehrwertsteuer: \
    $\frac {V_{erleiherrechnung}}{1+\frac{M_{WST}}{100}}\cdot\frac{M_{WST}}{100}$
    -   Gewinn / Verlust: \
    $U_{msatzKinokasse} - S_{uisa-Vorabzug} - V_{erleiherrechnung}$ 


```{r echo=FALSE}
df_temp <- df_keine_Rechnnung|>
  filter(Datum == c_Date[ii])

if(nrow(df_temp) > 0) {
  writeLines("Achtung es gibt noch keine Verleiherabrechnung für diesen Film.")
}else{
  df_temp <-df_Abrechnung |>
    filter(Datum %in% c(c_Date[ii]))
  
  if(!is.na(df_temp$`Link Datum`)){
    paste("Dieser Film wird zusammen mit diesem Datum", 
        paste0(lubridate::day(df_temp$`Link Datum`),".",lubridate::month(df_temp$`Link Datum`),".",lubridate::year(df_temp$`Link Datum`)), 
        "abgerechnet.")|>
    writeLines()  
  }
}
```

```{r}
c_Verleiher_garantie <- df_verleiherabgaben|>
  filter(Datum == c_Datum )|>
  select(`Minimal Abzug`)|>
  pull()
```

```{r echo=FALSE}
df_temp <- df_Abrechnung|>
  filter(Datum == c_Datum & `Suisa Nummer` == c_suisa)|>
  mutate(`Total Abgaben [CHF]` = sum(`SUISA-Vorabzug [CHF]`,`Verleiherabzug [CHF]`,na.rm = T))
```

#### Abgaben

Für diesen Film wurden mit dem Verleiher **`r c_verleiherabgaben`%** des Ticket-Umsatz ausgehandelt die durch den Verleiher verrechnet werden. Die minimalen Abgaben (Garantierter Umsatz) an den Verleiher ist **`r c_Verleiher_garantie`.- [CHF].**. Der Abgabeprozentsatz und die mindest Garantie muss für jeden Film und Spielwoche mit dem jeweiligen Verleiher verhandelt.

```{r}
Filmvorführungen <- df_temp$`Gewinn/Verlust Tickets [CHF]`
```

```{r}
df_temp <- df_Abrechnung|>
  filter(Datum == c_Datum & `Suisa Nummer` == c_suisa)

df_temp|>
  select(`Gewinn/Verlust Tickets [CHF]`)|>
  knitr::kable()
```

\

## Event

### Einnahmen

Beiträge von Mitveranstalter, Sponsoring for diesen Event.

```{r}
Eventeinnahmen <- l_abrechnung[[ii]]$Eventeinnahmen|>
  select(Datum, Bezeichnung, Betrag)|>
  rename(`Betrag [CHF]` = Betrag)
```

```{r}
Eventeinnahmen|>
  mutate(Datum = paste0(day(Datum),".", month(Datum),".", year(Datum)))|>
  knitr::kable(digits = 2)
```

```{r}
Eventeinnahmen <- Eventeinnahmen|>
  reframe(`Summe [CHF]` = sum(`Betrag [CHF]`,na.rm = T)|>round5Rappen()|>round(2)
          )

Eventeinnahmen|>
  knitr::kable()

```

### Ausgaben

Alle Ausgaben die für diesen Event, z.B. Ausgaben für Spezialverkaufsartikel, Deko, Flyer, ...\

```{r}
Eventausgaben <- l_abrechnung[[ii]]$Eventausgaben|>
  select(Datum, Bezeichnung, Betrag)|>
  rename(`Betrag [CHF]` = Betrag)

Eventausgaben|>
  mutate(Datum = paste0(day(Datum),".", month(Datum),".", year(Datum)))|>
  knitr::kable(digits = 2)
```

```{r}
Eventausgaben <- Eventausgaben|>
  reframe(`Summe [CHF]` = sum(`Betrag [CHF]`,na.rm = T)|>round5Rappen()|>round(2)
          )

Eventausgaben|>
  knitr::kable()
```

### Differenz

```{r}
df_temp <- tibble(Bezeichnung = c("Einnahmen","Ausgaben"),
       `Betrag [CHF]` = c(Eventeinnahmen|>pull()|>round5Rappen(),
                          -Eventausgaben|>pull()|>round5Rappen()
                          )
       )

df_temp|>
  knitr::kable()
```

```{r}
Event <- df_temp|>
  reframe(`Betrag [CHF]` = sum(`Betrag [CHF]`, na.rm = T))

Event|>
  knitr::kable()
```

\

## Kiosk

### Einnahmen

#### Gewinn pro Artikel

```{r echo=FALSE}
df_temp <- df_Kiosk|>
  filter(Datum == c_Datum)|>
  select(-Datum)|>
  rename(`Kassiert [CHF]` = `Kassiert`,
         `Einkaufspreis [CHF]` =`Einkaufspreis`,
         `Verkaufspreis [CHF]`=`Verkaufspreis`)
```

```{r echo=FALSE}
df_temp1 <-  df_temp|>
  filter(!is.na(Lieferant))|>
  rename(`Gewinn [CHF]` = Gewinn)|>
  select(Verkaufsartikel, `Verkaufspreis [CHF]`, Anzahl, `Kassiert [CHF]`, `Einkaufspreis [CHF]`, Lieferant, `Gewinn [CHF]`)

df_temp1|>
  knitr::kable()
```

```{r}
df_temp1 <- df_temp1|>
  filter(!is.na(Lieferant))|>
  reframe(`Summe [CHF]` = sum(`Gewinn [CHF]`, na.rm = T)
          |>round5Rappen())

df_temp1|>
  knitr::kable()
```

#### Umsatz Spezialverkaufsartikel

Verkaufsartikel ohne Lieferant.

```{r echo=FALSE}
df_temp3 <- df_spez_preis_na

if(df_temp3|>nrow()){
  paste0(
      "Für die Filmvorführung ", df_temp3$Filmtitel, " am ", day(df_temp3$Datum),".",month(df_temp3$Datum),".", year(df_temp3$Datum),
      " wurde der Artikel ", df_temp3$Verkaufsartikel," nicht definiert.",
      "\nBitte korrigieren in der Datei:","\n.../Kinoklub/input/Spezialpreisekiosk.xlsx\n"
  )|>
    writeLines()
}
```

```{r echo=FALSE}
df_temp2 <- df_temp|>
  filter(is.na(Lieferant))|>
  rename(`Umsatz [CHF]` = Gewinn)

df_temp2|>
  select(Verkaufsartikel,`Verkaufspreis [CHF]`, Anzahl, `Kassiert [CHF]`)|>
  knitr::kable()
```

```{r}
df_temp2 <- df_temp|>
  filter(is.na(Lieferant))|>
  reframe(`Summe [CHF]` = sum(Gewinn, na.rm = T)|>round5Rappen())

df_temp2|>
  knitr::kable()
```

### Ausgaben

Die Ausgaben für Spezialartikel müssen mit den Eventausgaben verrechnet werden!\

```{r echo=FALSE}
if(df_temp2$`Summe [CHF]` > 0) {
  if(abs(Event$`Betrag [CHF]`) <= 0){
  writeLines("Achtung es gibt keine Eventausgaben obwohl Spezialverkaufsartikel verkauft wurden.
             \nBitte die Einkäufe unter Eventausgaben im File .../Kinoklub/input/Einnahmen und Ausgaben.xlsx nachtragen")
  }
}

```

```{r echo=FALSE}
if(df_temp3|>nrow()){
  paste0(
      "Für die Filmvorführung ", df_temp3$Filmtitel, " am ", day(df_temp3$Datum),".",month(df_temp3$Datum),".", year(df_temp3$Datum),
      " wurde der Artikel ", df_temp3$Verkaufsartikel," nicht definiert.",
      "\nBitte korrigieren in der Datei:","\n.../Kinoklub/input/Spezialpreisekiosk.xlsx\n"
  )|>
    writeLines()

  df_temp <- Einnahmen_und_Ausgaben$Ausgaben|>
  filter(Spieldatum == c_Datum, Kategorie == Einnahmen_und_Ausgaben$dropdown$`drop down`[1])
  
  if(nrow(df_temp) == 0) {
    writeLines("\n Es sind keine Eventausgaben vorhanden mit denen die Spezialverkaufsartikel bezahlt wurden!")
    }

}

```

### Differenz

Achtung!\
Die Kioskkasse wird auch für dir Barauszahlung von stornierten Tickets genutzt.

```{r echo=FALSE}
Manko <- df_manko_uerberschuss|>
  filter(Datum == c_Datum)|>
  select(-Datum)|>
  rename(`Summe [CHF]` = `Überschuss / Manko`)
```

```{r echo=FALSE}
df_temp <- bind_cols(tibble(Bezeichnung = c("Gewinn pro Artikel", "Umsatz", "Manko / Überschuss")), 
                     bind_rows(df_temp1, df_temp2,Manko)
                     )|>
  rename(`Betrag [CHF]` = `Summe [CHF]`)

df_temp|>
  knitr::kable()
```

```{r echo=FALSE}
Kiosk <- df_temp|>
  reframe(`Summe [CHF]` = sum(`Betrag [CHF]`, na.rm = T)|>round5Rappen())

Kiosk|>
  knitr::kable()
```

\

## Gewinn / Verlust

```{r}
df_temp <- tibble(
  Bezeichnung = c("Flimvorführung", "Event", "Kiosk"),
  `Betrag [CHF]` = c(Filmvorführungen,
                     Event|>pull(),
                     Kiosk|>pull()
  )
)

df_temp|>
  knitr::kable()
```

```{r}
df_temp|>
  reframe(`Gewinn / Verlust [CHF]`=sum(`Betrag [CHF]`, na.rm = T))|>
  knitr::kable()
```

\
\
\
\
